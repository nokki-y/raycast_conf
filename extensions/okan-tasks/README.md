# おかんタスク確認 Raycast Extension

おかんスプレッドシートから期限が迫っているタスクをRaycastで素早く確認できる拡張機能です。

## 機能

- ✅ **期限フィルタリング**: 期限切れ + 2営業日以内のタスクのみ表示
- ✅ **ステータス自動判定**: 「完了」「対象外」を自動除外
- ✅ **直接編集**: タスクをクリックして該当セルで直接スプレッドシートを開く
- ✅ **軽量実装**: Google Sheets REST APIで高速動作
- ✅ **自動トークン更新**: アクセストークンは自動的にリフレッシュされます（手動更新不要）
- ✅ **バックグラウンド通知**: 期日切れ・今日締切のタスクを定期的に通知（24時間365日対応）
- ✅ **通知音カスタマイズ**: 14種類の通知音から選択可能＋テスト機能付き

## 前提条件

- Node.js (v16以上)
- Raycast がインストール済み
- Google Cloud Console へのアクセス権限

## セットアップ

### 1. Google Cloud Console の設定

#### 1.1 プロジェクトの作成

1. [Google Cloud Console](https://console.cloud.google.com/) にアクセス
2. 新しいプロジェクトを作成 (例: `raycast-okan`)

#### 1.2 Google Sheets API の有効化

1. 「APIとサービス」→「ライブラリ」をクリック
2. 「Google Sheets API」を検索
3. 「有効にする」をクリック

#### 1.3 OAuth 2.0 認証情報の作成

1. 「APIとサービス」→「認証情報」をクリック
2. 「認証情報を作成」→「OAuthクライアントID」を選択
3. 同意画面の設定を求められたら、以下を設定:
   - ユーザータイプ: 外部
   - アプリ名: 任意 (例: Raycast Okan)
   - サポートメール: あなたのメールアドレス
   - スコープは追加不要
   - テストユーザー: あなたのGoogleアカウントを追加
4. アプリケーションの種類: **デスクトップアプリ**
5. 名前: 任意 (例: raycast-okan-client)
6. 「作成」をクリック

#### 1.4 認証情報のダウンロード

1. 作成した認証情報の右側にあるダウンロードアイコン(↓)をクリック
2. JSONファイルがダウンロードされます
3. ファイルを `extensions/okan-tasks/.auth/credentials.json` に配置

```bash
# ダウンロードしたJSONファイルを移動してリネーム
mv ~/Downloads/client_secret_*.json extensions/okan-tasks/.auth/credentials.json
```

**注意**: `.auth/` ディレクトリ内のファイルはGitで管理されません(秘匿情報のため)。

### 2. 初回認証とトークン取得

#### 2.1 OAuth認証フローを実行

認証スクリプトを実行して、初回のOAuth認証を行います：

```bash
cd extensions/okan-tasks
npm install
npm run setup-auth
```

#### 2.2 認証の流れ

1. ブラウザでURLが表示されます
2. URLをブラウザで開く
3. Googleアカウントでログイン
4. アクセス許可を承認
5. 表示される認証コードをコピー
6. ターミナルに認証コードを貼り付けて Enter

成功すると、`extensions/okan-tasks/.auth/token.json` にアクセストークンとリフレッシュトークンが保存されます。

**重要**: アクセストークンは自動的にリフレッシュされます。手動で更新する必要はありません。

#### 2.3 認証情報の同期

開発モードとRaycast拡張ディレクトリに認証情報を同期します：

```bash
npm run sync-auth
```

このコマンドは、`.auth/`ディレクトリの内容をRaycastの拡張ディレクトリにコピーします。

### 3. Raycast Preferences の設定

Raycastで拡張機能を開き、以下の設定を行います：

1. **Spreadsheet ID**: スプレッドシートのID
   - URLの `https://docs.google.com/spreadsheets/d/{SPREADSHEET_ID}/edit` から取得
2. **Sheet Name**: シート名（例: `【Todo】タスク一覧`）
3. **Sheet GID**: シートのGID
   - URLの `?gid={GID}` から取得
4. **My Name**: あなたの名前（例: `山田 太郎`）
   - スプレッドシートの列ヘッダーと完全一致させること

### 4. Raycast への登録

#### 4.1 開発モードで実行

```bash
cd extensions/okan-tasks
npm run dev
```

これにより、Raycastに拡張機能が自動的に追加されます。

#### 4.2 使い方

##### 手動確認
1. Raycastを起動 (⌘ + Space)
2. `Check Okan Tasks` と入力
3. **期限切れ・2営業日以内の未完了タスク**の一覧が表示されます
4. タスクを選択して Enter を押すと、**あなたのステータスセル**が選択された状態でスプレッドシートが開きます

##### バックグラウンド通知（推奨）
1. Raycast Preferences を開く (⌘ + ,)
2. **Extensions** → **Okan Tasks** → **Okan Tasks - Background Notifications** を探す
3. **Background Refresh** トグルを **ON** にする
4. 通知間隔を設定（デフォルト: 1時間、テスト用: 1分）
5. 通知音を好みの音に変更（デフォルト: Basso）

これにより、期日切れまたは今日締切のタスクがあれば自動的に通知されます。

##### 通知音のテスト
1. Raycast を開く (⌘ + Space)
2. `Test Notification Sound` と入力して実行
3. 現在設定されている通知音でテスト通知が送信されます

### 4.3 表示されるタスク

以下の条件をすべて満たすタスクのみが表示されます：

- ✅ あなたの列（例: CI列）のステータスが「完了」「対象外」以外
- ✅ 期日が**期限切れ** または **2営業日以内**
- ✅ タスクタイトルが存在する

**営業日の計算**: 土日を除いた営業日で計算されます。
- 例: 今日が金曜日 → 2営業日後は火曜日

## トラブルシューティング

### エラー: 401 Unauthorized

通常、このエラーは発生しません（自動リフレッシュ機能があるため）。もし発生した場合：

```bash
npm run sync-auth
```

を実行してトークンを同期してください。

### エラー: 自分の列が見つかりません

- Raycast Preferencesの `My Name` がスプレッドシートの列ヘッダーと完全一致しているか確認
- 空白文字や全角/半角に注意
- スプレッドシートに十分な列数のデータがあるか確認

### タスクが表示されない

1. スプレッドシートIDが正しいか確認
2. シート名が正しいか確認
3. あなたの列に「完了」「対象外」以外の値があるか確認（空欄も表示対象）
4. タスクの期日が**期限切れまたは2営業日以内**か確認

### タスクはあるのに0件と表示される

- 期日が3営業日以降のタスクは表示されません
- 期日の形式が `M/D` 形式（例: `10/28`, `11/4`）であることを確認

## ファイル構成

```
extensions/okan-tasks/
├── src/
│   ├── check-okan-tasks.tsx        # メインのRaycastコマンド（手動確認用）
│   ├── notify-okan-tasks.tsx       # バックグラウンド通知コマンド
│   ├── test-notification-sound.tsx # 通知音テストコマンド
│   ├── sheets-api.ts               # Google Sheets REST API呼び出し（自動トークンリフレッシュ機能付き）
│   └── setup-auth.ts               # OAuth認証セットアップスクリプト
├── scripts/
│   ├── sync-auth.sh                # 認証情報同期スクリプト
│   └── build-release.sh         # リリースパッケージビルドスクリプト
├── .auth/                       # 認証情報（Gitで管理しない）
│   ├── credentials.json         # OAuth クライアント情報
│   └── token.json               # アクセストークン・リフレッシュトークン
├── assets/
│   └── icon.png                 # 拡張機能のアイコン
├── package.json
├── README.md                    # 開発者向けドキュメント
└── SETUP_GUIDE.md               # 配布先向けセットアップガイド
```

## 技術仕様

### スプレッドシート構造

- **1行目**: ヘッダー行（列名）
- **2-4行目**: メタ情報行（部署、UserID、カウント行）
- **5行目以降**: 実際のタスクデータ

### データ取得

- **C列（index 2）**: タスクタイトル
- **D列（index 3）**: 期日
- **E列（index 4）**: 時間
- **あなたの列**: あなたのステータス（列は設定した名前で検索）

### 期限判定ロジック

1. 今日の日付を取得
2. 2営業日後の日付を計算（土日除く）
3. タスクの期日をパース（M/D形式）
4. `期日 <= 2営業日後` のタスクのみ表示

### バックグラウンド通知

- **チェック間隔**: 1分ごと（`package.json`の`interval: "1m"`で固定）
- **通知間隔**: ユーザー設定（1分/30分/1時間/2時間/4時間）
- **通知音**: ユーザー設定（14種類から選択可能、デフォルト: Basso）
- **通知条件**: 期日切れまたは今日締切のタスクがある場合
- **動作時間**: 24時間365日（時間帯・曜日制限なし）
- **再起動検出**: Raycast再起動時に自動的にタイマーをリセット
- **テスト機能**: `Test Notification Sound`コマンドで通知音を事前確認可能

## 注意事項

- **認証情報は機密情報です**。共有しないでください
  - `credentials.json`: OAuth クライアント情報
  - `token.json`: アクセストークン・リフレッシュトークン
- これらのファイルは`.gitignore`に含まれており、Gitにコミットされません
- アクセストークンは自動的にリフレッシュされます（手動更新不要）

## 配布について

### ビルド済みパッケージで配布（推奨）

エンドユーザーに開発環境を要求しない方式：

```bash
npm run release
```

詳細は [DISTRIBUTION_GUIDE.md](DISTRIBUTION_GUIDE.md) を参照してください。

### ソースコードから配布（開発者向け）

開発環境がある技術者向けには、[SETUP_GUIDE.md](SETUP_GUIDE.md) を参照してもらいます。
